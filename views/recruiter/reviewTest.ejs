<%- include('../partials/header') %>
<%- include('../partials/sidebar', { user }) %>

<!-- Responsive Main Wrapper -->
<div class="p-4 sm:p-6 mt-12 lg:p-8 lg:ml-64 bg-gray-50 min-h-screen transition-all duration-300">

  <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-4 sm:p-6 lg:p-8">

    <!-- Test Header -->
    <h2 class="text-xl sm:text-2xl font-bold text-blue-700 mb-3 sm:mb-4"><%= test.title %></h2>
    <p class="text-gray-600 mb-4 sm:mb-6 leading-relaxed"><%= test.description %></p>

    <!-- Overall Timer & Finish -->
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-4">
      <div>
        <span class="font-semibold text-base sm:text-lg">Time Remaining: </span>
        <span id="testTimer" class="text-red-600 font-bold text-lg"></span>
      </div>
      <button id="finishBtn"
        class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 w-full sm:w-auto text-center">
        Finish Test
      </button>
    </div>

    <!-- Progress Info -->
    <p class="mb-2 text-gray-700 text-sm sm:text-base">
      Question <span id="currentQuestionNum">1</span> of <%= test.Questions.length %> |
      Attempted: <span id="attemptedCount">0</span>
    </p>

    <!-- Question Container -->
    <div id="questionContainer" class="border p-3 sm:p-4 rounded mb-4">

      <p id="questionText" class="font-semibold mb-4 text-sm sm:text-base"></p>

      <div id="optionsContainer" class="flex flex-col gap-2"></div>

      <p class="mt-2 text-blue-600 font-semibold text-sm sm:text-base">
        Time Left: <span id="questionTimer"></span> sec
      </p>

      <!-- Navigation -->
      <div class="mt-4 flex flex-col sm:flex-row justify-between gap-2 sm:gap-0">
        <button id="prevBtn"
          class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 w-full sm:w-auto">
          Previous
        </button>
        <button id="nextBtn"
          class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full sm:w-auto">
          Next
        </button>
      </div>

    </div>
  </div>
</div>

<script>
  // Questions from backend
  const questions = <%- JSON.stringify(test.Questions) %>;
  let currentIndex = 0;
  const totalQuestions = questions.length;
  const answers = new Array(totalQuestions).fill(null);

  // ===================== TEST TIMER =====================
  let totalTime = <%= test.durationMinutes * 60 %>;
  const testTimerEl = document.getElementById("testTimer");

  function updateTestTimer() {
    const minutes = Math.floor(totalTime / 60);
    const seconds = totalTime % 60;
    testTimerEl.innerText = `${minutes}:${seconds < 10 ? "0" + seconds : seconds}`;
    if (totalTime <= 0) {
      clearInterval(testInterval);
      finishTest();
    }
    totalTime--;
  }

  const testInterval = setInterval(updateTestTimer, 1000);

  // ===================== ELEMENTS =====================
  const questionTextEl = document.getElementById("questionText");
  const optionsContainerEl = document.getElementById("optionsContainer");
  const questionTimerEl = document.getElementById("questionTimer");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const finishBtn = document.getElementById("finishBtn");
  const currentQuestionNumEl = document.getElementById("currentQuestionNum");
  const attemptedCountEl = document.getElementById("attemptedCount");

  let questionInterval;
  let questionTimeLeft;

  // ===================== SHOW QUESTION =====================
  function showQuestion(index) {
    if (index < 0 || index >= totalQuestions) return;
    currentIndex = index;

    const q = questions[index];
    questionTextEl.innerText = `${index + 1}. ${q.text} (${q.marks} marks)`;

    // Clear options
    optionsContainerEl.innerHTML = "";

    if (q.type === "Subjective") {
      const textarea = document.createElement("textarea");
      textarea.className = "w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-400 text-sm sm:text-base";
      textarea.rows = 4;
      textarea.placeholder = "Type your answer here...";
      textarea.value = answers[index] || "";
      textarea.addEventListener("input", () => {
        answers[index] = textarea.value.trim();
        updateAttemptedCount();
      });
      optionsContainerEl.appendChild(textarea);

    } else {
      for (let key in q.options) {
        const div = document.createElement("div");
        div.className = "flex items-start gap-2 text-sm sm:text-base";
        div.innerHTML = `
          <input type="radio" name="answer" value="${key}"
            ${answers[index] === key ? "checked" : ""} />
          <span>${key}) ${q.options[key]}</span>`;
        optionsContainerEl.appendChild(div);
      }
    }

    // QUESTION TIMER
    clearInterval(questionInterval);
    questionTimeLeft = q.timeLimit || 30;
    questionTimerEl.innerText = questionTimeLeft;

    questionInterval = setInterval(() => {
      questionTimeLeft--;
      questionTimerEl.innerText = questionTimeLeft;

      if (questionTimeLeft <= 0) {
        clearInterval(questionInterval);
        saveAnswer();
        if (currentIndex < totalQuestions - 1) showQuestion(currentIndex + 1);
        else finishTest();
      }
    }, 1000);

    currentQuestionNumEl.innerText = currentIndex + 1;
    updateAttemptedCount();
  }

  // ===================== SAVE ANSWER =====================
  function saveAnswer() {
    const q = questions[currentIndex];

    if (q.type === "Subjective") {
      const textarea = optionsContainerEl.querySelector("textarea");
      answers[currentIndex] = textarea ? textarea.value.trim() : "";

    } else {
      const selected = document.querySelector('input[name="answer"]:checked');
      answers[currentIndex] = selected ? selected.value : null;
    }

    updateAttemptedCount();
  }

  // ===================== ATTEMPT COUNT =====================
  function updateAttemptedCount() {
    const attempted = answers.filter((a) => a && a.length > 0).length;
    attemptedCountEl.innerText = attempted;
  }

  // ===================== NAVIGATION =====================
  nextBtn.addEventListener("click", () => {
    saveAnswer();
    if (currentIndex < totalQuestions - 1) showQuestion(currentIndex + 1);
  });

  prevBtn.addEventListener("click", () => {
    saveAnswer();
    if (currentIndex > 0) showQuestion(currentIndex - 1);
  });

  finishBtn.addEventListener("click", () => {
    saveAnswer();
    finishTest();
  });

  // ===================== FINISH TEST =====================
  function finishTest() {
    clearInterval(testInterval);
    clearInterval(questionInterval);

    if (!confirm("Are you sure you want to finish the test?")) return;

    alert("Your answers have been submitted successfully!");
  }

  // Initialize
  showQuestion(0);
</script>
