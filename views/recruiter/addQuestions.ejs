<%- include('../partials/header') %>
<%- include('../partials/sidebar', { user }) %>

<div class="p-4 md:p-8 mt-14 bg-gray-50 min-h-screen transition-all duration-300 md:ml-64">
  <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-md p-4 sm:p-8">

    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6 border-b pb-4">
      <h2 class="text-2xl sm:text-3xl font-bold text-blue-700 flex items-center gap-3">
        Add Questions to: <%= test.title %>
      </h2>
      <a href="/recruiter/tests" class="text-sm text-gray-600 hover:text-blue-600 flex items-center gap-1">
        <i class="fa-solid fa-arrow-left"></i> Back to Tests
      </a>
    </div>

    <% if (typeof uploadSuccess !== 'undefined' && uploadSuccess == '1') { %>
      <div class="mb-4 p-3 bg-green-100 text-green-800 border border-green-300 rounded flex items-center gap-2">
        <i class="fa-solid fa-circle-check"></i>
        Questions Uploaded Successfully!
      </div>
    <% } %>

    <!-- Upload via Excel -->
    <div class="mb-10 bg-gray-100 p-5 rounded-xl border border-gray-200">
      <h3 class="text-lg font-semibold mb-3 text-gray-800 flex items-center gap-2">
        <i class="fa-solid fa-file-excel text-green-600"></i> Upload Questions via Excel
      </h3>

      <form action="/questions/uploadPreview" method="POST" enctype="multipart/form-data" class="space-y-3">
        <input type="hidden" name="testId" value="<%= test.id %>">
        <div>
          <label class="block text-gray-700 font-medium mb-1">
            Select Excel File <span class="text-red-500">*</span>
          </label>
          <input
            type="file"
            name="excelFile"
            required
            accept=".xlsx,.xls"
            class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-400"
          />
          <p class="text-xs text-gray-500 mt-1">
            Format: Question | A | B | C | D | Correct | Marks | Type | TimeLimit
          </p>
        </div>
        <button type="submit"
          class="bg-purple-600 text-white px-5 py-2 rounded-lg hover:bg-purple-700 transition flex items-center gap-2">
          <i class="fa-solid fa-upload"></i> Upload & Preview
        </button>
      </form>
    </div>

    <!-- Manual Add Question Form -->
    <form id="questionsForm" action="/recruiter/test/<%= test.id %>/add-questions" method="POST" class="space-y-6">
      <input type="hidden" name="testId" value="<%= test.id %>">

      <div id="questionsContainer">
        <div class="question-block border p-5 rounded-lg bg-gray-50 shadow-sm mb-4">

          <!-- Question Type -->
          <div class="mb-3">
            <label class="block text-gray-800 font-semibold mb-1">Question Type</label>
            <select name="type[]" class="question-type w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400" required>
              <option value="Objective" selected>Objective</option>
              <option value="Subjective">Subjective</option>
            </select>
          </div>

          <!-- Question Text -->
          <div>
            <label class="block text-gray-800 font-semibold mb-1">Question Text <span class="text-red-500">*</span></label>
            <textarea name="text[]" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400" required></textarea>
          </div>

          <!-- Options -->
          <div class="options-section grid grid-cols-1 sm:grid-cols-2 gap-4 mt-3">
            <% ["A","B","C","D"].forEach(opt => { %>
              <div>
                <label class="block text-gray-700">Option <%= opt %> <span class="text-red-500">*</span></label>
                <input name="option<%= opt %>[]"
                       class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400 option-input"
                       required />
              </div>
            <% }) %>
          </div>

          <!-- Correct Answer / Marks / Time -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-3">
            <div class="correct-section">
              <label class="block text-gray-700 font-semibold mb-1">
                Correct Answer (A/B/C/D) <span class="text-red-500">*</span>
              </label>
              <input name="correctAnswer[]" class="w-full border rounded-lg px-3 py-2 correct-input" required />
            </div>

            <div>
              <label class="block text-gray-700 font-semibold mb-1">Marks <span class="text-red-500">*</span></label>
              <input type="number" name="marks[]" value="1" class="w-full border rounded-lg px-3 py-2" required />
            </div>

            <div>
              <label class="block text-gray-700 font-semibold mb-1">Time Limit (seconds) <span class="text-red-500">*</span></label>
              <input type="number" name="timeLimit[]" value="30" class="w-full border rounded-lg px-3 py-2" required />
            </div>
          </div>
        </div>
      </div>

      <!-- Buttons -->
      <div class="flex flex-col sm:flex-row justify-between items-center gap-3 mt-6">
        <button type="button" id="addMoreBtn"
                class="bg-gray-600 text-white px-5 py-2 rounded-lg flex items-center gap-2 hover:bg-gray-700 transition">
           Add More
        </button>
        <button type="submit"
                class="bg-blue-600 text-white px-6 py-2 rounded-lg flex items-center gap-2 hover:bg-blue-700 transition">
           Submit All
        </button>
      </div>
    </form>

    <hr class="my-10">

    <!-- Existing Questions -->
    <h3 class="text-xl font-bold text-blue-700 mb-4 flex items-center gap-2">
      <i class="fa-solid fa-list"></i> Existing Questions
    </h3>

    <% if (test.Questions && test.Questions.length > 0) { %>
      <ul class="space-y-3">
        <% test.Questions.forEach(q => { %>
          <li class="border p-4 rounded-lg bg-gray-100 flex flex-col md:flex-row justify-between items-start gap-3 hover:bg-gray-50 transition">
            <div>
              <p class="font-medium text-gray-800"><%= q.text %> (<%= q.marks %> marks)</p>

              <% if (q.type === 'Objective') { %>
                <p class="text-sm text-gray-600">
                  A: <%= q.options.A %> | B: <%= q.options.B %> | C: <%= q.options.C %> | D: <%= q.options.D %>
                </p>
                <p class="text-green-600 font-semibold text-sm mt-1">
                  <i class="fa-solid fa-check"></i> Correct: <%= q.correctAnswer %>
                </p>
              <% } else { %>
                <p class="italic text-gray-500 text-sm">Subjective Question</p>
              <% } %>

              <% if (q.timeLimit) { %>
                <p class="text-blue-600 text-sm mt-1">
                  <i class="fa-regular fa-clock"></i> Time Limit: <%= q.timeLimit %> sec
                </p>
              <% } %>
            </div>

            <div class="flex space-x-2">
              <a href="/recruiter/test/<%= test.id %>/question/<%= q.id %>/edit"
                 class="px-3 py-1 bg-yellow-400 rounded hover:bg-yellow-500 text-white text-sm flex items-center gap-1">
                <i class="fa-solid fa-pen-to-square"></i>
              </a>
              <form action="/recruiter/test/<%= test.id %>/question/<%= q.id %>?_method=DELETE" method="POST">
                <button type="submit"
                        class="px-3 py-1 bg-red-600 rounded hover:bg-red-700 text-white text-sm flex items-center gap-1"
                        onclick="return confirm('Are you sure you want to delete this question?');">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </form>
            </div>
          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <div class="text-center py-10 text-gray-500">
        <i class="fa-solid fa-folder-open text-5xl mb-3"></i>
        <p>No questions added yet.</p>
      </div>
    <% } %>
  </div>
</div>

<!-- JS for Add More + Type Toggle -->
<script>
  const addMoreBtn = document.getElementById('addMoreBtn');
  const questionsContainer = document.getElementById('questionsContainer');

  addMoreBtn.addEventListener('click', () => {
    const newBlock = document.querySelector('.question-block').cloneNode(true);
    newBlock.querySelectorAll('textarea, input').forEach(input => {
      if (input.name.includes('marks')) input.value = 1;
      else if (input.name.includes('timeLimit')) input.value = 30;
      else input.value = '';
    });
    questionsContainer.appendChild(newBlock);
  });

  document.addEventListener('change', (e) => {
    if (e.target.classList.contains('question-type')) {
      const block = e.target.closest('.question-block');
      const optionsSection = block.querySelector('.options-section');
      const correctSection = block.querySelector('.correct-section');

      if (e.target.value === 'Subjective') {
        optionsSection.style.display = 'none';
        correctSection.style.display = 'none';
        block.querySelectorAll('.option-input, .correct-input').forEach(inp => inp.removeAttribute('required'));
      } else {
        optionsSection.style.display = 'grid';
        correctSection.style.display = 'block';
        block.querySelectorAll('.option-input, .correct-input').forEach(inp => inp.setAttribute('required', true));
      }
    }
  });
</script>
