<%- include('../partials/header') %>

<div class="flex min-h-screen bg-gray-100">

  <!-- Sidebar -->
  <div class="w-64">
    <%- include('../partials/sidebar') %>
  </div>

  <!-- Main Content Wrapper -->
  <div class="flex-1 p-6 max-w-5xl mx-auto">

    <!-- Create Assignment Form -->
    <h2 class="text-2xl font-bold mb-4">Create Assignment</h2>
    <form action="/assignments/create" method="POST" class="space-y-4 bg-white p-6 rounded shadow mb-12">

      <!-- Title -->
      <div>
        <label class="block font-semibold mb-1">Title</label>
        <input type="text" name="title" required class="border p-2 rounded w-full focus:outline-none focus:ring focus:border-blue-300"/>
      </div>

      <!-- Description -->
      <div>
        <label class="block font-semibold mb-1">Description</label>
        <textarea name="description" rows="3" class="border p-2 rounded w-full focus:outline-none focus:ring focus:border-blue-300"></textarea>
      </div>

      <!-- Code -->
      <div>
        <label class="block font-semibold mb-1">Code (unique)</label>
        <input type="text" name="code" class="border p-2 rounded w-full focus:outline-none focus:ring focus:border-blue-300"/>
      </div>

      <!-- Select Test -->
      <div>
        <label class="block font-semibold mb-1">Select Test</label>
        <select id="testSelect" name="testId" required class="border p-2 rounded w-full focus:outline-none focus:ring focus:border-blue-300">
          <option value="">Select Test</option>
          <% tests.forEach(test => { %>
            <option value="<%= test.id %>"><%= test.title %></option>
          <% }) %>
        </select>
        <div class="flex gap-4 mt-2">
          <a href="/tests/create" class="text-blue-600 hover:underline text-sm">+ Add New Test</a>
          <a href="/questions/manage" class="text-blue-600 hover:underline text-sm">Manage Questions</a>
        </div>
      </div>

      <!-- Questions -->
      <div>
        <h3 class="font-semibold mb-2 flex justify-between items-center">
          Questions <span id="questionCount" class="text-sm text-gray-500">(0)</span>
        </h3>
        <div id="questionList" class="max-h-64 overflow-y-auto p-2 border rounded bg-gray-50 space-y-2">
          <!-- Dynamically populated questions will appear here -->
        </div>
      </div>

      <!-- Hidden input for selected questions -->
      <input type="hidden" name="questionIds" id="questionIds" />

      <!-- Duration -->
      <div>
        <label class="block font-semibold mb-1">Duration (minutes)</label>
        <input type="number" name="duration" min="1" class="border p-2 rounded w-full focus:outline-none focus:ring focus:border-blue-300" />
      </div>

      <!-- Passing Marks -->
      <div>
        <label class="block font-semibold mb-1">Passing Marks</label>
        <input type="number" name="passingMarks" min="0" class="border p-2 rounded w-full focus:outline-none focus:ring focus:border-blue-300" />
      </div>

      <!-- Submit -->
      <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">Create Assignment</button>
    </form>

    <!-- Assignment List -->
    <div class="bg-white p-6 rounded shadow">
      <h2 class="text-2xl font-bold mb-4">Assignment List</h2>

      <% if (assignments.length === 0) { %>
        <p class="text-gray-500">No assignments found.</p>
      <% } else { %>
        <table class="w-full border border-gray-200 rounded overflow-hidden">
          <thead class="bg-gray-100 text-left">
            <tr>
              <th class="py-2 px-4 border-b">Title</th>
              <th class="py-2 px-4 border-b">Test</th>
              <th class="py-2 px-4 border-b">Duration</th>
              <th class="py-2 px-4 border-b">Passing Marks</th>
              <th class="py-2 px-4 border-b">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% assignments.forEach(a => { %>
              <tr class="hover:bg-gray-50">
                <td class="py-2 px-4 border-b"><%= a.title %></td>
                <td class="py-2 px-4 border-b"><%= a.test ? a.test.title : 'N/A' %></td>
                <td class="py-2 px-4 border-b"><%= a.duration || '-' %></td>
                <td class="py-2 px-4 border-b"><%= a.passingMarks || '-' %></td>
                <td class="py-2 px-4 border-b space-x-2">
                  <a href="/assignments/view/<%= a.id %>" class="text-blue-600 hover:underline">View</a>
                  <a href="/assignments/edit/<%= a.id %>" class="text-yellow-600 hover:underline">Edit</a>
                  <form action="/assignments/delete/<%= a.id %>" method="POST" class="inline" onsubmit="return confirm('Are you sure you want to delete this assignment?');">
                    <button type="submit" class="text-red-600 hover:underline bg-none border-none cursor-pointer p-0">Delete</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      <% } %>
    </div>

  </div>

</div>

<script>
  const questionList = document.getElementById('questionList');
  const questionIdsInput = document.getElementById('questionIds');
  const questionCount = document.getElementById('questionCount');

  document.getElementById('testSelect').addEventListener('change', async function () {
    const testId = this.value;
    questionList.innerHTML = '';
    questionIdsInput.value = '';
    questionCount.textContent = '(0)';
    if (!testId) return;

    try {
      const res = await fetch(`/tests/${testId}/questions/json`);
      if (!res.ok) throw new Error('Failed to fetch questions');
      const data = await res.json();

      data.questions.forEach(q => {
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between bg-white p-2 rounded shadow-sm';

        div.innerHTML = `
          <label class="flex items-center gap-2 flex-1 cursor-pointer">
            <input type="checkbox" class="qchk" value="${q.id}" /> ${q.text}
          </label>
          <span class="text-xs text-gray-400">${q.marks || 1} marks</span>
        `;

        questionList.appendChild(div);
      });

      // Add change event to all checkboxes
      questionList.querySelectorAll('.qchk').forEach(cb => cb.addEventListener('change', updateQuestions));
      updateQuestions();

    } catch (error) {
      console.error(error);
      questionList.innerHTML = '<p class="text-red-600">Could not load questions.</p>';
    }
  });

  function updateQuestions() {
    const selected = Array.from(document.querySelectorAll('.qchk:checked')).map(cb => cb.value);
    questionIdsInput.value = JSON.stringify(selected.map(id => ({ id })));
    questionCount.textContent = `(${selected.length})`;
  }
</script>

<%- include('../partials/footer') %>
